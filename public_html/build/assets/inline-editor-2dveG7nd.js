class d{constructor(){this.isActive=!1,this.activeElement=null,this.originalContent=null,this.toolbar=null,this.overlay=null,this.pageId=null,this.contentMap={},this.init()}async init(){var t;if(this.pageId=(t=document.querySelector("[data-page-id]"))==null?void 0:t.dataset.pageId,!this.pageId){console.error("Page ID not found");return}this.createToolbar(),this.createOverlay(),await this.loadSavedContent(),this.makeElementsEditable(),this.attachEventListeners(),this.showWelcomeMessage()}async loadSavedContent(){try{const e=await(await fetch(`/api/inline-edit/content/${this.pageId}`,{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}})).json();e.success&&e.content_map&&(this.contentMap=e.content_map,this.applySavedContent())}catch(t){console.error("Error loading saved content:",t)}}applySavedContent(){Object.keys(this.contentMap).forEach(t=>{const e=document.getElementById(t);e&&(e.textContent=this.contentMap[t])})}createToolbar(){this.toolbar=document.createElement("div"),this.toolbar.id="inline-edit-toolbar",this.toolbar.innerHTML=`
            <div class="inline-toolbar-content">
                <div class="toolbar-left">
                    <span class="toolbar-icon">‚úèÔ∏è</span>
                    <span class="toolbar-title">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
                    <span class="toolbar-hint">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
                </div>
                <div class="toolbar-right">
                    <button id="inline-help-btn" class="toolbar-btn" title="–ü–æ–º–æ—â—å">
                        <i class="bi bi-question-circle"></i>
                    </button>
                    <button id="inline-exit-btn" class="toolbar-btn toolbar-btn-exit" title="–í—ã–π—Ç–∏">
                        <i class="bi bi-x-lg"></i> –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>
        `,document.body.appendChild(this.toolbar)}createOverlay(){this.overlay=document.createElement("div"),this.overlay.id="inline-edit-overlay",document.body.appendChild(this.overlay)}showWelcomeMessage(){const t=document.createElement("div");t.id="inline-welcome-message",t.innerHTML=`
            <div class="welcome-content">
                <h4>üéâ –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</h4>
                <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, —á—Ç–æ–±—ã –µ–≥–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.</p>
                <p class="text-muted small mb-0">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
                <button id="close-welcome" class="btn-close-welcome">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        `,document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},100),document.getElementById("close-welcome").addEventListener("click",()=>{t.classList.remove("show"),setTimeout(()=>t.remove(),300)}),setTimeout(()=>{t.parentNode&&(t.classList.remove("show"),setTimeout(()=>t.remove(),300))},5e3)}makeElementsEditable(){const t=["h1","h2","h3","h4","h5","h6","p","span","a","li",".lead",".text-muted",".hero-title",".display-1",".display-2",".display-3",".display-4",".display-5",".display-6"],e=["#inline-edit-toolbar","#inline-edit-overlay","#inline-edit-panel","#inline-welcome-message","nav","footer","script","style","button","input","textarea","select",".hero-overlay",".btn",".navbar","form"],n=document.querySelectorAll(t.join(",")),s={};n.forEach(i=>{if(e.some(o=>i.closest(o)!==null))return;const a=i.textContent&&i.textContent.trim().length>0,l=Array.from(i.children).some(o=>t.some(c=>o.matches(c)));if(!(!a||l)){if(!i.id){const o=i.tagName.toLowerCase();s[o]||(s[o]=0),i.id=`editable-${o}-${s[o]}`,s[o]++}i.classList.add("inline-editable"),i.setAttribute("data-original-content",i.textContent),i.addEventListener("mouseenter",o=>{this.activeElement||(i.classList.add("inline-hover"),this.showOverlay(i))}),i.addEventListener("mouseleave",o=>{this.activeElement||(i.classList.remove("inline-hover"),this.hideOverlay())}),i.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),this.startEditing(i)})}})}showOverlay(t){const e=t.getBoundingClientRect();this.overlay.style.display="block",this.overlay.style.top=e.top+window.scrollY+"px",this.overlay.style.left=e.left+window.scrollX+"px",this.overlay.style.width=e.width+"px",this.overlay.style.height=e.height+"px"}hideOverlay(){this.overlay.style.display="none"}startEditing(t){this.activeElement&&this.cancelEditing(),this.activeElement=t,this.originalContent=t.textContent,t.contentEditable=!0,t.classList.add("inline-editing"),t.focus();const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e),this.createEditPanel(t),this.hideOverlay()}createEditPanel(t){const e=document.createElement("div");e.id="inline-edit-panel",e.innerHTML=`
            <button id="inline-save-btn" class="edit-panel-btn edit-panel-save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">
                <i class="bi bi-check-lg"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button id="inline-cancel-btn" class="edit-panel-btn edit-panel-cancel" title="–û—Ç–º–µ–Ω–∏—Ç—å">
                <i class="bi bi-x-lg"></i> –û—Ç–º–µ–Ω–∏—Ç—å
            </button>
        `,document.body.appendChild(e);const n=t.getBoundingClientRect();e.style.top=n.bottom+window.scrollY+10+"px",e.style.left=n.left+window.scrollX+"px",document.getElementById("inline-save-btn").addEventListener("click",()=>{this.saveChanges(t)}),document.getElementById("inline-cancel-btn").addEventListener("click",()=>{this.cancelEditing()}),t.addEventListener("keydown",s=>{s.ctrlKey&&s.key==="Enter"?(s.preventDefault(),this.saveChanges(t)):s.key==="Escape"&&(s.preventDefault(),this.cancelEditing())})}async saveChanges(t){const e=t.textContent.trim();if(e===this.originalContent){this.cancelEditing();return}if(!e){alert("–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!");return}const n=document.getElementById("inline-save-btn");n.disabled=!0,n.innerHTML='<i class="bi bi-hourglass-split"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';try{console.log("Saving changes:",{pageId:this.pageId,elementId:t.id,oldContent:this.originalContent,newContent:e});const i=await(await fetch("/api/inline-edit/update",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({page_id:this.pageId,element_id:t.id,content:e})})).json();if(console.log("Save response:",i),i.success)this.contentMap[t.id]=e,t.setAttribute("data-original-content",e),this.showNotification("‚úì –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!","success"),this.finishEditing();else throw new Error(i.error||"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏")}catch(s){console.error("Save error:",s),this.showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: "+s.message,"error"),n.disabled=!1,n.innerHTML='<i class="bi bi-check-lg"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}}cancelEditing(){this.activeElement&&(this.activeElement.textContent=this.originalContent,this.finishEditing())}finishEditing(){if(!this.activeElement)return;this.activeElement.contentEditable=!1,this.activeElement.classList.remove("inline-editing","inline-hover");const t=document.getElementById("inline-edit-panel");t&&t.remove(),this.activeElement=null,this.originalContent=null}showNotification(t,e="success"){const n=document.createElement("div");n.className=`inline-notification inline-notification-${e}`,n.innerHTML=`
            <i class="bi bi-${e==="success"?"check-circle":"exclamation-circle"}"></i>
            <span>${t}</span>
        `,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},3e3)}attachEventListeners(){document.getElementById("inline-exit-btn").addEventListener("click",()=>{this.activeElement?confirm("–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")&&this.exit():this.exit()}),document.getElementById("inline-help-btn").addEventListener("click",()=>{this.showHelp()}),document.addEventListener("click",t=>{var e;this.activeElement&&!this.activeElement.contains(t.target)&&((e=document.getElementById("inline-edit-panel"))!=null&&e.contains(t.target))})}showHelp(){const t=document.createElement("div");t.id="inline-help-modal",t.innerHTML=`
            <div class="help-overlay" id="help-overlay"></div>
            <div class="help-content">
                <h3>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å inline-—Ä–µ–¥–∞–∫—Ç–æ—Ä</h3>
                <ul>
                    <li>üñ±Ô∏è <strong>–ö–ª–∏–∫</strong> - –Ω–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ —Ç–µ–∫—Å—Ç –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                    <li>‚úèÔ∏è <strong>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</strong> - –∏–∑–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–∞–∫ –≤–∞–º –Ω—É–∂–Ω–æ</li>
                    <li>üíæ <strong>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</strong> - –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –∏–ª–∏ Ctrl+Enter</li>
                    <li>‚ùå <strong>–û—Ç–º–µ–Ω–∞</strong> - –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–º–µ–Ω–∏—Ç—å" –∏–ª–∏ Esc</li>
                    <li>üö™ <strong>–í—ã—Ö–æ–¥</strong> - –Ω–∞–∂–º–∏—Ç–µ "–í—ã–π—Ç–∏" –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏</li>
                </ul>
                <button id="close-help" class="btn-close-help">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        `,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10);const e=()=>{t.classList.remove("show"),setTimeout(()=>t.remove(),300)};document.getElementById("close-help").addEventListener("click",e),document.getElementById("help-overlay").addEventListener("click",e)}exit(){var e;const t=(e=document.querySelector("[data-page-id]"))==null?void 0:e.dataset.pageId;t?window.location.href=`/admin/pages/${t}/edit`:window.location.href="/admin/pages"}}document.addEventListener("DOMContentLoaded",()=>{document.body.dataset.inlineEdit==="true"&&(window.inlineEditor=new d)});
